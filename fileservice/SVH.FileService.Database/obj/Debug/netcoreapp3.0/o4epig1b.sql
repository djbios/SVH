CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL,
    CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
);

CREATE TABLE "Files" (
    "Id" bigserial NOT NULL,
    "FileId" uuid NOT NULL,
    "FileName" text NULL,
    "UploadDate" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Files" PRIMARY KEY ("Id")
);

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20190823155732_Initial', '3.1.0');

ALTER TABLE "Files" ADD "LastSyncDate" timestamp with time zone NOT NULL DEFAULT TIMESTAMPTZ '0001-01-01 00:00:00+00:00';

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20190916115845_LastSyncDate', '3.1.0');

ALTER TABLE "Files" ALTER COLUMN "Id" TYPE bigint;
ALTER TABLE "Files" ALTER COLUMN "Id" SET NOT NULL;
ALTER SEQUENCE "Files_Id_seq" RENAME TO "Files_Id_old_seq";
ALTER TABLE "Files" ALTER COLUMN "Id" DROP DEFAULT;
ALTER TABLE "Files" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY;
PERFORM setval('"Files_Id_seq"', nextval('"Files_Id_old_seq"'), false);
DROP SEQUENCE "Files_Id_old_seq";

CREATE TABLE "Conversions" (
    "Id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "SourceId" bigint NULL,
    "ResultId" bigint NULL,
    "VideoFormat" integer NOT NULL,
    "Tryes" bigint NOT NULL,
    "Status" integer NOT NULL,
    CONSTRAINT "PK_Conversions" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Conversions_Files_ResultId" FOREIGN KEY ("ResultId") REFERENCES "Files" ("Id") ON DELETE RESTRICT,
    CONSTRAINT "FK_Conversions_Files_SourceId" FOREIGN KEY ("SourceId") REFERENCES "Files" ("Id") ON DELETE RESTRICT
);

CREATE INDEX "IX_Conversions_ResultId" ON "Conversions" ("ResultId");

CREATE INDEX "IX_Conversions_SourceId" ON "Conversions" ("SourceId");

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20191205153154_ConversionModel', '3.1.0');

